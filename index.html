<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <script type="text/javascript" src="js/main.js"></script>



</head>
<body>
	<script type="text/javascript">
    var currentTime = new Date().getTime();
    var width = window.innerWidth;
    var height = window.innerHeight;	
    
    var app = Elm.Main.init({flags: {currentTime: currentTime, width: width, height: height}});
    
    app.ports.saveToLocalStorage.subscribe(function(data) {
    	addToDatabase(data);
	});

	app.ports.loadFromLocalStorage.subscribe(function(key) {
  		console.log("loading " + key + " from database");
		
		var request = db.transaction(['nameDict'])
  			.objectStore('nameDict')
  			.index('filename')
  			.get(key);
		
		request.onerror = function(event) {
            console.log("Unable to retrieve daa from database!");
        };
            
        request.onsuccess = function(event) {
               
           	if(request.result) {
           	   app.ports.loadedFromLocalStorage.send(request.result);
            } else {
               app.ports.loadedFromLocalStorage.send({ noData : key });
            }
        };
	});

	var request = window.indexedDB.open("japElmNames",2);

	request.onerror = function (event) {
		console.log('The database failed opening');
	};

	var db;

	request.onsuccess = function (event) {
		db = request.result;
		console.log('The database has opened successfully');
	};

	request.onupgradeneeded = function (event) {
		db = event.target.result;
		console.log('onupgradeneeded');

		var objectStore;
	
		if (!db.objectStoreNames.contains('nameDict')) {
			objectStore = db.createObjectStore('nameDict', { autoIncrement: true });
			objectStore.createIndex('filename', 'filename', { unique: true });
			objectStore.createIndex('content', 'content', { unique: false });
		}
	}

	

	function addToDatabase(data) {
  		console.log("saving " + data.filename + " to database");
  		var request = db.transaction(['nameDict'], 'readwrite')
  			.objectStore('nameDict')
  			.add({ filename: data.filename, content: data.content });

		request.onsuccess = function (event) {
		    console.log('The data has been written successfully');
		};

  		request.onerror = function (event) {
    		console.log('The data has not been written successfully');
  		};
	}

	function getFromDatabase(key){
		console.log("loading " + key + " to database");
		
		var request = db.transaction(['nameDict'])
  			.objectStore('nameDict')
  			.index('filename')
  			.get(key);
		
		request.onerror = function(event) {
            console.log("Unable to retrieve daa from database!");
        };
            
        request.onsuccess = function(event) {
               
           	if(request.result) {
           	   console.log(request.result);
               return request.result;
            } else {
               return null;
            }
        };
	}


    </script>
</body>

</html>